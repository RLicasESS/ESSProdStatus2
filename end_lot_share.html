<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>END LOT (SHARE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; background: #000; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 10px; }

    canvas { width: 100%; height: auto; display: block; border-radius: 14px; background: #fff; }
    img { display: none; }

    .err {
      color: #fff; background: #b00020; padding: 12px; margin: 10px;
      border-radius: 12px; font-family: Arial, sans-serif; font-weight: 900; white-space: pre-wrap;
    }

    /* small top hint on phone (optional) */
    .hint {
      color:#111; background:#ffd400; margin:10px; padding:8px 10px;
      border-radius: 12px; font: 14px/1.3 Arial, sans-serif; font-weight: 900;
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="hint" class="hint"></div>
    <div id="error" class="err" style="display:none;"></div>

    <!-- hidden image source -->
    <img id="handlerImg" alt="handler" />

    <!-- final output (screenshot this) -->
    <canvas id="outCanvas"></canvas>
  </div>

  <script>
    // ✅ ESSProdStatus2 CSV
    const CSV_URL = "https://raw.githubusercontent.com/RLicasESS/ESSProdStatus2/main/ESSProd.csv";

    // ✅ Handler IP map (RequestServer on :8080 serves /latest.png)
    const HANDLER_IP = {
      "NS-3":   "10.20.10.187",
      "NS-4":   "10.20.10.238",
      "NS-5":   "10.20.10.98",
      "CHROMA": "10.20.10.38",
    };

    // Refresh cadence (share page can refresh slower)
    const REFRESH_MS = 30000;

    const params   = new URLSearchParams(location.search);
    const tester   = (params.get("tester") || "").trim();
    const nextStep = (params.get("next") || "").trim(); // optional passthrough
    const showHint = (params.get("hint") || "") === "1";

    const $ = (id)=>document.getElementById(id);

    function setErr(msg){
      $("error").style.display = msg ? "" : "none";
      $("error").textContent = msg || "";
    }

    function setHint(msg){
      const h = $("hint");
      if (!showHint) { h.style.display = "none"; return; }
      h.style.display = msg ? "" : "none";
      h.textContent = msg || "";
    }

    function norm(s){ return String(s ?? "").replace(/\r/g,"").trim().toUpperCase(); }
    function parseCSV(text){
      const lines = text.replace(/\r/g,"").trim().split(/\n/);
      if (!lines.length) return [];
      const delim = lines[0].includes("\t") ? "\t" : ",";
      return lines.map(l => l.split(delim));
    }
    function findRow(rows, label){
      const want = norm(label);
      return (rows || []).find(r => norm(r?.[0]) === want) || null;
    }
    function pickRow(rows, labels){
      for (const lb of labels){
        const r = findRow(rows, lb);
        if (r) return r;
      }
      return null;
    }
    function safeCell(row, c){ return row && c < row.length ? String(row[c] ?? "").trim() : ""; }
    function findColByTester(rows, tester){
      const header = rows?.[0] || [];
      const want = norm(tester);
      for (let c = 1; c < header.length; c++){
        if (norm(header[c]) === want) return c;
      }
      return -1;
    }
    function stamp(){
      const d = new Date();
      const p = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }

    function handlerPngUrl(handlerName){
      const h = norm(handlerName).replace(/_/g,"-");
      const ip = HANDLER_IP[h];
      if (!ip) return "";
      return `http://${ip}:8080/latest.png?ts=${Date.now()}`;
    }

    async function loadAndRender(){
      setErr("");
      setHint("");

      if (!tester){
        setErr("Missing tester.\nExample:\nend_lot_share.html?tester=AP-1");
        return;
      }

      // Load CSV
      const resp = await fetch(
        CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "v=" + Date.now(),
        { cache: "no-store" }
      );
      if (!resp.ok) throw new Error(`CSV fetch failed: ${resp.status} ${resp.statusText}`);

      const rows = parseCSV(await resp.text());
      if (!rows.length) throw new Error("CSV parsed empty");

      const col = findColByTester(rows, tester);
      if (col < 0) throw new Error(`Tester '${tester}' not found in ESSProd.csv header`);

      const handlerRow = pickRow(rows, ["HANDLER"]);
      const lotRow     = pickRow(rows, ["LOT NUMBER", "LOT", "LOT_ID"]);
      const prodRow    = pickRow(rows, ["PRODUCT", "PRODUCT NAME", "PRODUCT_NAME"]);
      const stepRow    = pickRow(rows, ["TEST STEP", "STEP", "CURRENT STEP"]);
      const tempRow    = pickRow(rows, ["TEMP", "TEMPERATURE", "TEMP(C)", "TEMP (C)"]);

      const handler = safeCell(handlerRow, col).toUpperCase();
      const lot     = safeCell(lotRow, col);
      const product = safeCell(prodRow, col);
      const step    = safeCell(stepRow, col);
      const temp    = safeCell(tempRow, col);

      if (!handler) throw new Error("HANDLER cell is blank for this tester.");

      // Load handler PNG from the handler Pi RequestServer
      const pngUrl = handlerPngUrl(handler);
      if (!pngUrl) throw new Error(`No HANDLER_IP mapping for handler '${handler}'`);

      setHint(`Tester=${tester} | Handler=${handler}\n${pngUrl}`);

      const img = $("handlerImg");
      img.src = pngUrl;

      await new Promise((resolve, reject)=>{
        img.onload = resolve;
        img.onerror = ()=>reject(new Error(
          "Handler image failed to load.\n\n" +
          "Most common causes:\n" +
          "1) Phone is not on the 10.20.10.x network / VPN.\n" +
          "2) Handler RequestServer not running on :8080.\n" +
          "3) Browser blocked HTTP image (if this page is opened via HTTPS).\n\n" +
          "URL:\n" + pngUrl
        ));
      });

      // Label lines
      const line1 = product || "(PRODUCT)";
      let line2 = lot || "(LOT)";
      if (temp && line2 && !/-(\d+(\.\d+)?)C$/i.test(line2) && /C$/i.test(temp)){
        line2 = `${line2}-${temp.replace(/\s+/g,"")}`;
      }

      // include handler on share page label
      // Example: "AP-2 / BIN-1/5 (NS-4) | Next RT1"
      const donePart = `${tester} / ${step || "STEP"} (${handler})`;
      const line3 = nextStep ? `${donePart} | Next ${nextStep}` : donePart;

      // Render combined image
      const canvas = $("outCanvas");
      const ctx = canvas.getContext("2d");

      const W = 1200;
      const pad = 40;
      const labelH = 300;
      const imgMaxH = 720;

      const scale = Math.min(W / img.naturalWidth, imgMaxH / img.naturalHeight);
      const drawW = Math.round(img.naturalWidth * scale);
      const drawH = Math.round(img.naturalHeight * scale);

      const H = pad + drawH + pad + labelH + pad;
      canvas.width = W;
      canvas.height = H;

      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,W,H);

      const x = Math.round((W - drawW)/2);
      const y = pad;
      ctx.drawImage(img, x, y, drawW, drawH);

      const boxY = y + drawH + pad;
      const boxX = pad;
      const boxW = W - pad*2;
      const boxH = labelH;

      ctx.strokeStyle = "#111";
      ctx.lineWidth = 6;
      ctx.strokeRect(boxX, boxY, boxW, boxH);

      ctx.fillStyle = "#111";
      ctx.textAlign = "center";

      ctx.font = "bold 64px Arial";
      ctx.fillText(line1, W/2, boxY + 95);

      ctx.font = "bold 58px Arial";
      ctx.fillText(line2, W/2, boxY + 170);

      ctx.font = "bold 52px Arial";
      ctx.fillText(line3, W/2, boxY + 245);

      // timestamp
      ctx.font = "bold 26px Arial";
      ctx.textAlign = "right";
      ctx.fillText(stamp(), boxX + boxW - 10, boxY + boxH - 18);
    }

    async function refreshLoop(){
      try { await loadAndRender(); }
      catch(e){ setErr(String(e.message || e)); }
    }

    window.addEventListener("load", () => {
      refreshLoop();
      setInterval(refreshLoop, REFRESH_MS);
    });
  </script>
</body>
</html>
