<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESS PRODUCTION STATUS (DEV)</title>

  <style>
    html, body { margin:0; padding:0; background:#000; color:#ddd; font-family: Arial, Helvetica, sans-serif; }
    .wrap { padding: 14px; }
    h1 { margin: 0 0 10px 0; font-size: 18px; color:#fff; }
    .note { font-size: 12px; color:#aaa; margin-bottom: 12px; line-height:1.35; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,0.10); padding: 8px 10px; font-size: 12px; }
    th { text-align: left; color:#fff; position: sticky; top: 0; background: #090909; z-index: 1; }
    tr:hover td { background: rgba(255,255,255,0.03); }

    .lotLink { cursor: help; text-decoration: underline; text-underline-offset: 2px; }

    /* Hover popover */
    #yieldPopover {
      position: fixed;
      z-index: 9999;
      display: none;
      pointer-events: none;
      background: rgba(20,20,20,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 10px 8px 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      color: #ddd;
      max-width: 270px;
    }
    #yieldPopover .title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #yieldPopover .meta {
      font-size: 11px;
      color: #bbb;
      margin-top: 6px;
      line-height: 1.25;
      white-space: pre-line;
    }
    #yieldPopover canvas {
      display: block;
      width: 240px;
      height: 60px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ESS PRODUCTION STATUS (DEV)</h1>
    <div class="note">
      Hover a LOT to see a tiny yield history popover.
      This dev page tries to load <span class="mono">yield_history.json</span> from the same folder.
      If missing (or the lot isn’t found), it shows <b>MOCK DATA</b>.
    </div>

    <!-- SAMPLE TABLE ONLY (replace with your real table code) -->
    <table>
      <thead>
        <tr>
          <th>TESTER</th>
          <th>PRODUCT</th>
          <th>LOT</th>
          <th>STEP</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>S100_1</td>
          <td>ES9291Q</td>
          <td><span class="lotLink" data-lot="TGWDS13A84">TGWDS13A84</span></td>
          <td>B34_25C_FT1-RT1</td>
          <td>running</td>
        </tr>
        <tr>
          <td>S100_2</td>
          <td>ES9820Q</td>
          <td><span class="lotLink" data-lot="TGWBS00R31">TGWBS00R31</span></td>
          <td>FT1</td>
          <td>running</td>
        </tr>
        <tr>
          <td>AP-2</td>
          <td>ES9842</td>
          <td><span class="lotLink" data-lot="TGWBS02G30">TGWBS02G30</span></td>
          <td>25C_BIN2_65C_RT-2</td>
          <td>error</td>
        </tr>
        <tr>
          <td>AP-1</td>
          <td>ES9821</td>
          <td><span class="lotLink" data-lot="TGWDSXX959">TGWDSXX959</span></td>
          <td>25C_BIN1_25C_FT-1</td>
          <td>error</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Hover popover -->
  <div id="yieldPopover">
    <div class="title" id="ypTitle">Yield</div>
    <canvas id="ypCanvas" width="240" height="60"></canvas>
    <div class="meta" id="ypMeta"></div>
  </div>

  <script>
    // =========================
    // Yield history loader + MOCK fallback
    // =========================
    let yieldCache = null;

    function hash32(s) {
      s = String(s || "");
      let h = 2166136261 >>> 0;
      for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function genMockLotSeries(lot, n = 18) {
      const h = hash32(lot);
      const testerPool = ["AP-1", "AP-2", "S100_1", "S100_2"];
      const stepPool = ["FT1", "RT-1", "RT-2", "25C_BIN1_25C_FT-1", "25C_BIN2_65C_FT-1"];

      const tester = testerPool[h % testerPool.length];
      const step = stepPool[(h >>> 3) % stepPool.length];

      const base = 94 + ((h % 560) / 100);          // 94.00..99.59
      const amp  = 0.15 + (((h >>> 9) % 35) / 100); // 0.15..0.50 (% points)

      const start = Date.now() - n * 60 * 60 * 1000;
      const out = [];
      for (let i = 0; i < n; i++) {
        const w = Math.sin((i + (h % 7)) * 0.55) * amp + Math.cos((i + (h % 11)) * 0.23) * (amp * 0.6);
        const yPct = Math.max(80, Math.min(100, base + w));
        const total = 5000 + ((h + i * 97) % 18000);
        const good = Math.round(total * (yPct / 100));
        const t = new Date(start + i * 60 * 60 * 1000).toISOString();
        out.push({ t, tester, step, yield: +(yPct / 100).toFixed(6), good, total });
      }
      return out;
    }

    async function loadYieldHistory() {
      if (yieldCache) return yieldCache;

      try {
        const res = await fetch("yield_history.json", { cache: "no-store" });
        if (res.ok) {
          yieldCache = await res.json();
          yieldCache.__mock = false;
          return yieldCache;
        }
      } catch (e) {
        // ignore; fallback to mock
      }

      yieldCache = { __mock: true };
      return yieldCache;
    }

    // =========================
    // Popover sparkline drawing
    // =========================
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    function drawSparkline(canvas, yieldsPct) {
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // subtle baseline
      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.moveTo(0, h-1);
      ctx.lineTo(w, h-1);
      ctx.stroke();
      ctx.globalAlpha = 1;

      if (!yieldsPct || yieldsPct.length < 2) {
        ctx.beginPath();
        ctx.moveTo(6, h/2);
        ctx.lineTo(w-6, h/2);
        ctx.stroke();
        return;
      }

      let minY = Math.min(...yieldsPct);
      let maxY = Math.max(...yieldsPct);
      minY = clamp(minY, 80, 100);
      maxY = clamp(maxY, 80, 100);
      if (maxY - minY < 0.2) { maxY = minY + 0.2; }

      const pad = 6;
      const n = yieldsPct.length;
      const x = i => pad + (i * (w - pad*2) / (n-1));
      const y = v => {
        const t = (v - minY) / (maxY - minY);
        return (h - pad) - t * (h - pad*2);
      };

      ctx.beginPath();
      ctx.moveTo(x(0), y(yieldsPct[0]));
      for (let i=1; i<n; i++) ctx.lineTo(x(i), y(yieldsPct[i]));
      ctx.stroke();

      const lx = x(n-1), ly = y(yieldsPct[n-1]);
      ctx.beginPath();
      ctx.arc(lx, ly, 2.5, 0, Math.PI*2);
      ctx.fill();
    }

    function positionPopoverNearMouse(pop, ev) {
      const pad = 14;
      const vw = window.innerWidth, vh = window.innerHeight;

      pop.style.display = 'block';
      const w = pop.offsetWidth;
      const h = pop.offsetHeight;

      let left = ev.clientX + pad;
      let top  = ev.clientY + pad;

      if (left + w > vw - 6) left = ev.clientX - w - pad;
      if (top + h > vh - 6)  top  = ev.clientY - h - pad;

      pop.style.left = left + 'px';
      pop.style.top  = top + 'px';
    }

    async function showYieldPopoverForLot(lot, ev) {
      const pop = document.getElementById('yieldPopover');
      const title = document.getElementById('ypTitle');
      const meta = document.getElementById('ypMeta');
      const canvas = document.getElementById('ypCanvas');

      title.textContent = `Yield — ${lot}`;
      meta.textContent = 'Loading...';

      const hist = await loadYieldHistory();
      const isMock = !!hist.__mock;

      let rows = (hist && hist[lot]) ? hist[lot] : [];
      if (!rows.length) {
        rows = genMockLotSeries(lot, 18);
        hist[lot] = rows; // cache mock per-lot
      }

      const yieldsPct = rows.map(r => Math.round((r.yield || 0) * 10000) / 100);
      drawSparkline(canvas, yieldsPct);

      if (rows.length) {
        const last = rows[rows.length - 1];
        const y = Math.round((last.yield || 0) * 10000) / 100;
        const prefix = isMock ? "MOCK DATA (no yield_history.json)\n" : "";
        meta.textContent =
          prefix +
          `Last: ${last.t || ''}\n` +
          `Yield: ${y}%  (${last.good}/${last.total})\n` +
          `${last.tester || ''}  ${last.step || ''}`;
      } else {
        meta.textContent = (isMock ? "MOCK DATA\n" : "") + "No history for this lot.";
      }

      positionPopoverNearMouse(pop, ev);
    }

    function hideYieldPopover() {
      document.getElementById('yieldPopover').style.display = 'none';
    }

    // keep popover near cursor while visible
    document.addEventListener('mousemove', (ev) => {
      const pop = document.getElementById('yieldPopover');
      if (pop.style.display === 'block') positionPopoverNearMouse(pop, ev);
    });

    let hoverTimer = null;

    document.addEventListener('mouseover', (ev) => {
      const el = ev.target.closest('.lotLink');
      if (!el) return;
      const lot = el.getAttribute('data-lot') || el.textContent.trim();
      if (!lot) return;
      clearTimeout(hoverTimer);
      hoverTimer = setTimeout(() => showYieldPopoverForLot(lot, ev), 120);
    });

    document.addEventListener('mouseout', (ev) => {
      const el = ev.target.closest('.lotLink');
      if (!el) return;
      clearTimeout(hoverTimer);
      hideYieldPopover();
    });
  </script>
</body>
</html>
